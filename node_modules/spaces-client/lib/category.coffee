# Test commands:
#
# I wanted to post form data to achieve a more representative performance profile, but the node wizard complicated it so I switched over to json;
#
# curl -X POST -H "Cookie:_social_navigator_session=KRK4x-fEw24cTQ8c8BuKmLjJTYY" -H "ACCEPT:application/vnd.moxiesoft.spaces-v1+json" --data-urlencode "node[_type]=Category&node[title]=eos+quos&node[body]=error+expedita" https://xxkylee.moxiedev.com/categories/wizard_create
#
# data = $.param {
#   node: {
#     _type: "Category",
#     title: Faker.Lorem.sentences(1),
#     body: Faker.Lorem.sentences(4)
#   }
# }
#
# xhr.open('POST', site.full_url + "/categories/wizard_create", true)
# xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded")
#
# Here's the JSON version:
#
# curl -X POST -H "Cookie:_social_navigator_session=rGbu73bk-gXSbv23lDWWlqxLnC0" -H "CONTENT-TYPE:application/json" -H "ACCEPT:application/vnd.moxiesoft.spaces-v1+json" -d '{"category":{"title":"laboriosam laudantium vel omnis aut molestiae aut in","body":"blanditiis et nemo sed et nesciunt exercitationem\nprovident harum enim sapiente\nprovident ut molestiae possimus recusandae iste exercitationem qui dignissimos\nrepellendus itaque quisquam laudantium"}}' https://xxgonzalo.moxiedev.com/categories

Faker = require('Faker')
logger = require('./logger.js')
$ = require("jquery")

class Category

  @create = (site, parentId, userId) ->
    Spaces = require('./spaces-client.js')
    data = {
      category: {
        title: Faker.Lorem.sentences(1),
        body: Faker.Lorem.sentences(4)
      }
    }
    data['category']['parent_id'] = parentId if parentId

    XMLHttpRequest = require("xmlhttprequest").XMLHttpRequest
    xhr = new XMLHttpRequest()
    xhr.setDisableHeaderCheck(true) # needed to bypass security restrictions that prevent you from setting a cookie
    xhr.open('POST', site.full_url + "/categories", true)
    xhr.setRequestHeader("Content-Type", "application/json")
    xhr.setRequestHeader("Accept", "application/vnd.moxiesoft.spaces-v1+json")
    xhr.setRequestHeader("Cookie", ["_social_navigator_session=" + Spaces.Session.getSessionId(site, userId), "path=/"])
    xhr.onload = () ->
      if this.status == 200 | this.status == 201
        console.log "SUCCESS! " + this.responseText
        categoryId = this.responseText.match(/.*"id":"(.*?)".*/)[1]
        logger.debug("[%s][%s] Created category [%s]", site.site_id, userId, categoryId)
        Spaces.Session.addItem(site, userId, 'category', categoryId)
      else
        logger.error("[%s][%s] Category.create failed: %s - %s", site.site_id, userId, this.status, this.responseText)
    xhr.send(JSON.stringify(data))

module.exports = exports = Category