# Test commands:
#
# curl -v -X POST -H "Cookie:_social_navigator_session=WFhalcbwex0jEzlic5SmCCbPH5Q" -H "CONTENT-TYPE:application/x-www-form-urlencoded" -H "ACCEPT:application/vnd.moxiesoft.spaces-v1+json" -d 'document_library%5Btitle%5D=pequot&document_library%5Bparent_id%5D=5277babfbb1c4e4c79000213&document_library%5Bbody%5D=et+similique+fugiat+accusantium+quis+consequatur+aliquam+vitae+illo%0Aodit+ut+qui+nihil+modi+sunt+quod+aliquid%0Arerum+ea+dolores' https://xxryley.moxiedev.com/document_libraries

Faker = require('faker')
$ = require('jquery')
fs = require('fs')

# TODO - convert to form post instead of JSON
class Folder
  @create = (site, parentId, userId) ->
    Spaces = require('./spaces-client.js')
    data = {
      document_library: {
        title: Faker.Lorem.sentences(1),
#        created_with: 'wysiwyg',
#        body: Faker.Lorem.sentences(4),
#        tags: Faker.Lorem.words(3).join(" "),
        parent_id: parentId
      }
    }

    XMLHttpRequest = require("xmlhttprequest").XMLHttpRequest
    xhr = new XMLHttpRequest()
    xhr.setDisableHeaderCheck(true)
    xhr.open('POST', site.full_url + "/document_libraries", true)
#    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded")
    xhr.setRequestHeader("Content-Type", "application/json")
    xhr.setRequestHeader("Accept", "application/vnd.moxiesoft.spaces-v1+json")
    xhr.setRequestHeader("Cookie", ["_social_navigator_session=" + Spaces.Session.getSessionId(site, userId), "path=/"])
    xhr.onload = () ->
      if this.status == 200 || this.status == 201
        folderId = this.responseText.match(/"id":"(.*?)"/)[1]
        Spaces.logger.debug("[%s][%s] Created folder [%s]", site.site_id, userId, folderId)
        Spaces.Session.addItem(site, userId, 'folder', folderId)
      else
        Spaces.logger.error("[%s][%s] Folder.create failed: %s - %s", site.site_id, userId, JSON.stringify(xhr))
    xhr.onerror = (e) ->
      Spaces.logger.error(e)
    xhr.send(JSON.stringify(data))

  @createDocument = (site, folderId, userId) ->
    Spaces = require('./spaces-client.js')

    fileName = fileSize = null
    fs.readdir("./assets/files/", ( (err, files) ->
      throw err if err
      m = Math.floor(Math.random() * files.length)
      fileName = files[m]
      fs.stat("./assets/files/" + fileName, ((err, stats) ->
        throw err if err
        fileSize = stats.size
        Folder.initS3PresignedPost(site, userId, ((data) ->
          data = JSON.parse(data)
          Folder.uploadToS3(site, userId, data, fileName, fileSize, ( ->
            Spaces.logger.debug("[%s][%s] Uploaded document to S3", site.site_id, userId)
            Folder.createDocumentMetadata(folderId, site, userId, data, fileName, fileSize, ( (response) ->
              Spaces.logger.debug("[%s][%s] Created document [%s]", site.site_id, userId, documentId)
#              documentId = this.responseText.match(/"id":"(.*?)"/)[1]
              documentId = response.id
              Spaces.Session.addItem(site, userId, 'document', documentId)
            ), ((message) ->
              Spaces.logger.error(message)
            ))
          ), ((message) ->
            Spaces.logger.error(message)
          ))
        ), ((message) ->
          Spaces.logger.error(message)
        ))
      ))
    ))

  @initS3PresignedPost = (site, userId, onsuccess, onfail) ->
    Spaces = require('./spaces-client.js')
    XMLHttpRequest = require("xmlhttprequest").XMLHttpRequest
    xhr = new XMLHttpRequest()
    xhr.setDisableHeaderCheck(true)
    xhr.open('GET', site.full_url + "/documents/init_s3_presigned_post?legacy=false", true)
    xhr.setRequestHeader("Accept", "application/vnd.moxiesoft.spaces-v1+json")
    xhr.setRequestHeader("Cookie", ["_social_navigator_session=" + Spaces.Session.getSessionId(site, userId), "path=/"])
    xhr.onload = () ->
      if this.status == 200 || this.status == 201
        Spaces.logger.debug("[%s][%s] Folder.initS3PresignedPost succeeded: %s", site.site_id, userId, this.responseText)
        onsuccess(this.responseText)
      else
        Spaces.logger.error("[%s][%s] Folder.initS3PresignedPost failed: %s - %s", site.site_id, userId, this.status, this.responseText)
        onfail(this.status, this.responseText)
    xhr.send()

  @uploadToS3 = (site, userId, data, fileName, fileSize, onsuccess, onfail) ->
    Spaces = require('./spaces-client.js')

    boundaryKey = Math.random().toString(16)
    keys = ["AWSAccessKeyId", "key", "policy", "signature", "acl", "success_action_status"]

    body = "\r\n"
    for key in keys
      body += '--' + boundaryKey + '\r\n'
      body += 'Content-Disposition: form-data; name="' + key + '"\r\n\r\n'
      body += data.fields[key] + '\r\n'
    body += '--' + boundaryKey + '\r\n'
    body += 'Content-Disposition: form-data; name="file"; filename="' + fileName + '"\r\n'
    body += 'Content-Type: application/vnd.openxmlformats-officedocument.wordprocessingml.document\r\n\r\n'

    host = data.url.match(/https:\/\/(.*)\/$/)[1]
    post_options = {
      host: data.url.match(/https:\/\/(.*)\/$/)[1],
      method: 'POST',
      headers: {
        "Host": host,
        "Content-Type": 'multipart/form-data; boundary="'+boundaryKey+'"',
        "Content-Length": body.length + fileSize + ('\r\n--' + boundaryKey + '--').length,
        "Accept": 'application/vnd.moxiesoft.spaces-v1+json'
      }
    }

    # TODO change to https
    post_req = require('https').request(post_options, ((res) ->
      res.setEncoding('utf8')
      response = ""
      res.on('data', ((chunk) ->
        Spaces.logger.debug("[%s][%s] on data: %s", site.site_id, userId, chunk)
        response = response + chunk
      ))
      res.on('end', (() ->
        Spaces.logger.debug("[%s][%s] Folder.uploadToS3 request ended: %s - %s", site.site_id, userId, res.statusCode, res.status)
        if res.statusCode == 200 || res.statusCode == 201
          onsuccess()
        else
          onfail(res.statusCode)
      ))
    ))

    post_req.on('error', ((e) ->
      Spaces.logger.error("[%s][%s] Folder.uploadToS3 failed: %j", site.site_id, userId, e)
      onfail(e)
    ))
    post_req.write(body)

    x = fs.createReadStream('./assets/files/' + fileName, { bufferSize: 4 * 1024 })
    x.on('end', (() ->
        post_req.end('\r\n--' + boundaryKey + '--')
      ))
      .pipe(post_req, { end: false } )
      .on('error', ((e) ->
        Spaces.logger.error("[%s][%s] read stream error: %j", site.site_id, userId, e)
      ))

#    post_req.end()

# #####################################################################

#    XMLHttpRequest = require("xmlhttprequest").XMLHttpRequest
#    xhr = new XMLHttpRequest()
#    console.log "XHR: " + JSON.stringify(xhr)
#
#    xhr.setDisableHeaderCheck(true)
#    xhr.open('POST', data.match(/"url"\s*:\s*"(.*?)"/)[1], true)
#    xhr.setRequestHeader("Content-Type", 'multipart/form-data; boundary="'+boundaryKey+'"')
#    xhr.setRequestHeader("Accept", "application/vnd.moxiesoft.spaces-v1+json")
#    xhr.setRequestHeader("Cookie", ["_social_navigator_session=" + Spaces.Session.getSessionId(site, userId), "path=/"])
#    xhr.onload = () ->
#      if this.status == 200 || this.status == 201
#        Spaces.logger.debug("[%s][%s] @@uploadToS3 succeeded: %s", site.site_id, userId, this.responseText)
#        onsuccess(this.responseText)
#      else
#        Spaces.logger.error("[%s][%s] @initS3PresignedPost failed: %s - %s", site.site_id, userId, this.status, this.responseText)
#        onfail(this.status, this.responseText)
#    console.log "XHR: " + JSON.stringify(xhr)
#    xhr.send('--' + boundaryKey + '\r\n'
#      + 'Content-Type: application/octet-stream\r\n'
#      + 'Content-Disposition: form-data; name="' + fileName + '"; filename="' + fileName + '"\r\n'
#      + 'Content-Transfer-Encoding: binary\r\n\r\n' )
#
#    x = fs.createReadStream('./assets/files/' + fileName, { bufferSize: 4 * 1024 })
#    x.pipe(post_req, { end: false } )
#    x.on('end', (() ->
#        xhr.end('\r\n--' + boundaryKey + '--')
#    ))

  @createDocumentMetadata = (folderId, site, userId, data, fileName, fileSize, onsuccess, onfail) ->
    Spaces = require('./spaces-client.js')

    data = $.param {
      document: {
        parent_id: folderId,
        version: true,
        indirect_file_save: data.spaces_fields["document[indirect_file_save"],
        file_updated: data.spaces_fields["document[file_updated]"],
        upload: {
          file_id: data.spaces_fields["document[upload][file_id]"],
          file_s3_key: data.fields.key,
          file_name: fileName,
          file_size: fileSize,
          file_s3: data.spaces_fields["document[upload][file_s3]"]
        }
      }
    }

    XMLHttpRequest = require("xmlhttprequest").XMLHttpRequest
    xhr = new XMLHttpRequest()
    xhr.setDisableHeaderCheck(true)
    xhr.open('POST', site.full_url + "/document_libraries/" + folderId + "/documents", true)
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded")
#    xhr.setRequestHeader("Content-Type", "application/json")
    xhr.setRequestHeader("Accept", "application/vnd.moxiesoft.spaces-v1+json")
    xhr.setRequestHeader("Cookie", ["_social_navigator_session=" + Spaces.Session.getSessionId(site, userId), "path=/"])
    xhr.onload = () ->
      if this.status == 200 || this.status == 201
        onsuccess(this.responseText)
      else
        Spaces.logger.error("[%s][%s] Folder.createDocument failed: %s - %s", site.site_id, userId, this.status, this.responseText)
        onfail(this.status, this.responseText)
    xhr.send(data)

######################################################################################################
#
# GET /documents/init_s3_presigned_post?legacy=false&_=1383171124489
#
# Returns:
#
#{
#"fields": {
#  "AWSAccessKeyId": "AKIAJDPZ3DSPNJUPJVIQ",
#  "key": "spaces/527186059d70a261150000f2/${filename}",
#  "policy": "eyJleHBpcmF0aW9uIjoiMjAxMy0xMC0zMFQyMzoxOTo0OVoiLCJjb25kaXRpb25zIjpbeyJidWNrZXQiOiJzcGFjZXMtc3BhY2VzIn0sWyJzdGFydHMtd2l0aCIsIiRrZXkiLCJzcGFjZXMvNTI3MTg2MDU5ZDcwYTI2MTE1MDAwMGYyLyJdLHsiYWNsIjoicHJpdmF0ZSJ9LHsic3VjY2Vzc19hY3Rpb25fc3RhdHVzIjoiMjAxIn1dfQ==",
#  "signature": "PHZEqnAEnxLh0NmE1OdZQi1eLjg=",
#  "acl": "private",
#  "success_action_status": "201"
#},
#"url": "https://spaces-spaces.s3.amazonaws.com/",
#"spaces_fields": {
#  "document[indirect_file_save]": "true",
#  "document[file_updated]": "true",
#  "document[upload][file_id]": "527186059d70a261150000f2",
#  "document[upload][file_s3]": "true"
#}
#}
#
######################################################################################################
#
# POST https://spaces-spaces.s3.amazonaws.com/
#
# Content-Type: multipart/form-data; boundary=----WebKitFormBoundary95ufFwxgIJMZEnc6
#
#------WebKitFormBoundary95ufFwxgIJMZEnc6
#Content-Disposition: form-data; name="AWSAccessKeyId"
#
#AKIAJDPZ3DSPNJUPJVIQ
#------WebKitFormBoundary95ufFwxgIJMZEnc6
#Content-Disposition: form-data; name="key"
#
#spaces/52718445af9aba64bb000069/${filename}
#------WebKitFormBoundary95ufFwxgIJMZEnc6
#Content-Disposition: form-data; name="policy"
#
#eyJleHBpcmF0aW9uIjoiMjAxMy0xMC0zMFQyMzoxMjoyMVoiLCJjb25kaXRpb25zIjpbeyJidWNrZXQiOiJzcGFjZXMtc3BhY2VzIn0sWyJzdGFydHMtd2l0aCIsIiRrZXkiLCJzcGFjZXMvNTI3MTg0NDVhZjlhYmE2NGJiMDAwMDY5LyJdLHsiYWNsIjoicHJpdmF0ZSJ9LHsic3VjY2Vzc19hY3Rpb25fc3RhdHVzIjoiMjAxIn1dfQ==
#------WebKitFormBoundary95ufFwxgIJMZEnc6
#Content-Disposition: form-data; name="signature"
#
#gzqqx+fpVcHf+0PqdCyKFhJ1aG8=
#  ------WebKitFormBoundary95ufFwxgIJMZEnc6
#Content-Disposition: form-data; name="acl"
#
#private
#------WebKitFormBoundary95ufFwxgIJMZEnc6
#Content-Disposition: form-data; name="success_action_status"
#
#201
#------WebKitFormBoundary95ufFwxgIJMZEnc6
#Content-Disposition: form-data; name="file"; filename="Listener Build.docx"
#Content-Type: application/vnd.openxmlformats-officedocument.wordprocessingml.document
#
#
#------WebKitFormBoundary95ufFwxgIJMZEnc6--
#
######################################################################################################
#
# POST document_libraries/4f27858745a37a449b000032/documents
#
# document[parent_id]:4f27858745a37a449b000032
# document[version]:true
# document[indirect_file_save]:true
# document[file_updated]:true
# document[upload][file_id]:52718445af9aba64bb000069
# document[upload][file_s3_key]:spaces/52718445af9aba64bb000069/Listener Build.docx
# document[upload][file_name]:Listener Build.docx
# document[upload][file_size]:116108
# document[upload][file_s3]:true
#
######################################################################################################

module.exports = exports = Folder

#Exception save node!
# Mongo::OperationFailure 10161: Invalid modifier specified $setOnInsert:
# /mnt/apps/spaces/releases/3.3.1.3/vendor/bundle/ruby/1.9.1/gems/mongo-1.8.2/lib/mongo/networking.rb:87:in `send_message_with_gle'#012
# /mnt/apps/spaces/releases/3.3.1.3/vendor/bundle/ruby/1.9.1/gems/mongo-1.8.2/lib/mongo/collection.rb:482:in `block in update'#012
# /mnt/apps/spaces/releases/3.3.1.3/vendor/bundle/ruby/1.9.1/gems/mongo-1.8.2/lib/mongo/util/logging.rb:33:in `block in instrument'#012
# /mnt/apps/spaces/releases/3.3.1.3/vendor/bundle/ruby/1.9.1/gems/mongo-1.8.2/lib/mongo/util/logging.rb:65:in `instrument'#012
# /mnt/apps/spaces/releases/3.3.1.3/vendor/bundle/ruby/1.9.1/gems/mongo-1.8.2/lib/mongo/util/logging.rb:32:in `instrument'#012
# /mnt/apps/spaces/releases/3.3.1.3/vendor/bundle/ruby/1.9.1/gems/rpm_contrib-2.1.8/lib/rpm_contrib/instrumentation/mongo.rb:26:in `block in instrument_with_newrelic_trace'#012
# /mnt/apps/spaces/releases/3.3.1.3/vendor/bundle/ruby/1.9.1/gems/newrelic_rpm-3.5.3.25/lib/new_relic/agent/method_tracer.rb:242:in `trace_execution_scoped'#012
# /mnt/apps/spaces/releases/3.3.1.3/vendor/bundle/ruby/1.9.1/gems/rpm_contrib-2.1.8/lib/rpm_contrib/instrumentation/mongo.rb:24:in `instrument_with_newrelic_trace'#012
# /mnt/apps/spaces/releases/3.3.1.3/vendor/bundle/ruby/1.9.1/gems/mongo-1.8.2/lib/mongo/collection.rb:480:in `update'#012
# /mnt/apps/spaces/releases/3.3.1.3/vendor/bundle/ruby/1.9.1/gems/mongo_failover-0.0.1/lib/mongo_failover.rb:22:in `block in update_with_retry'#012
# /mnt/apps/spaces/releases/3.3.1.3/vendor/bundle/ruby/1.9.1/gems/mongo_failover-0.0.1/lib/mongo_failover.rb:155:in `rescue_connection_failure'#012
# /mnt/apps/spaces/releases/3.3.1.3/vendor/bundle/ruby/1.9.1/gems/mongo_failover-0.0.1/lib/mongo_failover.rb:21:in `update_with_retry'#012
# /mnt/apps/spaces/releases/3.3.1.3/app/models/n
