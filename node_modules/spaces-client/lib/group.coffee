$ = require("jquery")
Faker = require('Faker')

class Group
  @create = (site, parentId, userId) ->
    Spaces = require('./spaces-client.js')
    data = {
      group: {
        _type: "BasicGroup",
        title: Faker.Lorem.sentences(1),
        body: Faker.Lorem.sentences(4),
        parent_id: parentId
      }
    }

    XMLHttpRequest = require("xmlhttprequest").XMLHttpRequest
    xhr = new XMLHttpRequest()
    xhr.setDisableHeaderCheck(true)
    xhr.open('POST', site.full_url + "/groups", true)
    xhr.setRequestHeader("Content-Type", "application/json")
    xhr.setRequestHeader("Accept", "application/vnd.moxiesoft.spaces-v1+json")
    xhr.setRequestHeader("Cookie", ["_social_navigator_session=" + Spaces.Session.getSessionId(site, userId), "path=/"])
    xhr.onload = () ->
      if this.status == 200 || this.status == 201
        groupId = this.responseText.match(/"id":"(.*?)"/)[1]
        Spaces.logger.debug("[%s][%s] Created group [%s]", site.site_id, userId, groupId)
        Spaces.Session.addItem(site, userId, 'group', groupId)
      else
        Spaces.logger.error("[%s][%s] Group.create failed: %s - %s - %j", site.site_id, userId, this.status, this.responseText, data)
    xhr.send(JSON.stringify(data))

module.exports = exports = Group
