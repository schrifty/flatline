$ = require('jquery')

class Resource

  @createResource = (site, userId, className, dataJson) ->
    Spaces = require('./spaces-client.js')

    data = $.param dataJson

    opts = {
      hostname: site.full_url.match(/https:\/\/(.*)$/)[1],
      path: "/" + className + "s",
      method: 'POST',
      headers: {
        "Content-Type": "application/x-www-form-urlencoded"
        "Accept": 'application/vnd.moxiesoft.spaces-v1+json'
        "Cookie": ["_social_navigator_session=" + Spaces.Session.getSessionId(site, userId), "path=/"]
      }
    }

    req = require('https').request(opts, ((res) ->
      res.setEncoding('utf8')
      res.on('end', (() ->
        if res.statusCode == 200 || res.statusCode == 201
          forumId = this.responseText.match(/"id":"(.*?)"/)[1]
          Spaces.logger.debug("[%s][%s] Created %s [%s]", site.site_id, userId, className, forumId)
          Spaces.Session.addItem(site, userId, className, forumId)
        else
          Spaces.logger.debug("[%s][%s] %s#create/%s failed: %d - %s", site.site_id, userId, className,
            res.statusCode, res.status)
      ))
    ))
    req.on('error', ((e) ->
      Spaces.logger.error("[%s][%s] %s#delete/%s failed: %s", site.site_id, userId, className, id, req.statusCode)
    ))
    req.write(data)
    req.end()

  @deleteResource = (site, userId, className) ->
    Spaces = require('./spaces-client.js')
    id = Spaces.Session.getRandomUserItemIdOfType(site, userId, className)
    unless id
      Spaces.logger.info "[%s][%s] No appropriate %s can be found", site.site_id, userId, className
      return

    opts = {
      hostname: site.full_url.match(/https:\/\/(.*)$/)[1],
      path: "/" + className + "s/" + id,
      method: 'DELETE',
      headers: {
        "Accept": 'application/vnd.moxiesoft.spaces-v1+json'
        "Cookie": ["_social_navigator_session=" + Spaces.Session.getSessionId(site, userId), "path=/"]
      }
    }
    req = require('https').request(opts, ((res) ->
      res.setEncoding('utf8')
      res.on('end', (() ->
        if res.statusCode == 200 || res.statusCode == 201
          Spaces.logger.debug("[%s][%s] Deleted %s [%s]", site.site_id, userId, className, id)
        else
          Spaces.logger.debug("[%s][%s] %s#delete/%s failed: %d - %s", site.site_id, userId, className, id,
            res.statusCode, res.status)
      ))
    ))
    req.on('error', ((e) ->
      Spaces.logger.error("[%s][%s] %s#delete/%s failed: %s", site.site_id, userId, className, id, req.statusCode)
    ))
    req.end()

  @editResource = (site, userId, className, dataJson) ->
    Spaces = require('./spaces-client.js')
    id = Spaces.Session.getRandomUserItemIdOfType(site, userId, className)
    unless id
      Spaces.logger.info "[%s][%s] No appropriate %s can be found", site.site_id, userId, className
      return

    data = $.param dataJson

    opts = {
      hostname: site.full_url.match(/https:\/\/(.*)$/)[1],
      path: "/" + className + "s/" + id,
      method: 'PUT',
      headers: {
        "Content-Type": "application/x-www-form-urlencoded"
        "Accept": 'application/vnd.moxiesoft.spaces-v1+json'
        "Cookie": ["_social_navigator_session=" + Spaces.Session.getSessionId(site, userId), "path=/"]
      }
    }

    req = require('https').request(opts, ((res) ->
      res.setEncoding('utf8')
      res.on('end', (() ->
        if res.statusCode == 200 || res.statusCode == 201
          Spaces.logger.debug("[%s][%s] Updated %s [%s]", site.site_id, userId, className, id)
        else
          Spaces.logger.debug("[%s][%s] %s#update/%s failed: %d - %s", site.site_id, userId, className, id,
            res.statusCode, res.status)
      ))
    ))
    req.on('error', ((e) ->
      Spaces.logger.error("[%s][%s] %s#update/%s failed: %s", site.site_id, userId, className, id, req.statusCode)
    ))
    req.write(data)
    req.end()

module.exports = exports = Resource
