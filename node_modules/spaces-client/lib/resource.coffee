class Resource
  mockSpacesRequests = true

  $ = require('jquery')
  Util = require('./util')
  nock = require('nock')

  @getResource = (site, userId, sessionId, sPath, addlHeaders, onsuccess, onfail) ->
    Spaces = require('./spaces-client')

    headers = {}
    if addlHeaders
      headers = $.extend({}, headers, addlHeaders)

    host = site.full_url.match(/https:\/\/(.*)$/)[1]
    try siteId = host.match(/(.*?)\..*$/)[1]
    catch e then siteId = "unknown"

    opts = {
      headers: headers,
      hostname: host,
      path: "/" + sPath
    }

    nock(site.full_url).get(opts.path).reply(200, { "id": "12345" }) if mockSpacesRequests && host.match(/moxiedev/)

    req = require('https').request(opts, ((res) ->
      t1 = process.hrtime()
      res.setEncoding('utf8')
      resp = ""
      res.on('data', ((chunk) -> resp += chunk ))
      res.on('end', (() ->
        msecs = Util.hrdiff(t1, process.hrtime())
        if res.statusCode == 200
          onsuccess(msecs, resp)
        else
          Spaces.logger.error("[%s][%s] FAIL: GET %s (%d - %s) - %s", siteId, userId, sPath, res.statusCode, res.status, resp)
          onfail(msecs)
      ))
    ))
    req.on('error', ((e) ->
      Spaces.logger.error("[%s][%s] FAIL: GET %s (%s - %s)\n%s", siteId, userId, sPath, req.statusCode, e.message, e.stack)
      onfail(e)
    ))
    req.end()

  @createResource = (site, userId, sessionId, sPath, dataJson, onsuccess, onfail, oncreate) ->
    Spaces = require('./spaces-client')

    unless sessionId
      Spaces.logger.error("[%s][%s] NO SESSION ID", site.site_id, userId)
      return false

    data = $.param dataJson

    host = site.full_url.match(/https:\/\/(.*)$/)[1]
    opts = {
      hostname: host,
      path: "/" + sPath,
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "Accept": "application/vnd.moxiesoft.spaces-v1+json",
        "Cookie": ["_social_navigator_session=" + sessionId, "path=/"]
      }
    }

    nock(site.full_url).post(opts.path).reply(201, { "id": "12345" }) if mockSpacesRequests && host.match(/moxiedev/)

    resp = ""
    req = require('https').request(opts, ((res) ->
      t1 = process.hrtime()
      res.setEncoding('utf8')
      res.on('data', ((chunk) ->
        resp += chunk
      ))
      res.on('end', (() ->
        msecs = Util.hrdiff(t1, process.hrtime())
        if res.statusCode == 200 || res.statusCode == 201
          try
            id = resp.match(/"id":"(.*?)"/)[1]
            oncreate(id)
            onsuccess(msecs)
          catch e
            Spaces.logger.error("[%s][%s] FAIL: POST %s (%d - %s) [%s]\n%s", site.site_id, userId, sPath, res.statusCode, res.status, resp, e.stack)
            onfail(msecs)
        else
          Spaces.logger.error("[%s][%s] FAIL: POST %s (%d - %s) [%s]", site.site_id, userId, sPath, res.statusCode, res.status, resp)
          onfail(msecs)
      ))
    ))
    req.on('error', ((e) ->
      Spaces.logger.error("[%s][%s] FAIL: POST %s (%s - %s) [%s]\n%s", site.site_id, userId, sPath, req.statusCode, e.message, resp, e.stack)
      onfail()
    ))
    req.write(data)
    req.end()

  @deleteResource = (site, userId, sessionId, sPath, onsuccess, onfail, ondestroy) ->
    Spaces = require('./spaces-client')

    host = site.full_url.match(/https:\/\/(.*)$/)[1]
    opts = {
      hostname: host,
      path: "/" + sPath,
      method: 'DELETE',
      headers: {
        "Accept": 'application/vnd.moxiesoft.spaces-v1+json'
        "Cookie": ["_social_navigator_session=" + sessionId, "path=/"]
      }
    }

    nock(site.full_url).delete(opts.path).reply(200, { }) if mockSpacesRequests && host.match(/moxiedev/)

    req = require('https').request(opts, ((res) ->
      t1 = process.hrtime()
      res.setEncoding('utf8')
      res.on('end', (() ->
        msecs = Util.hrdiff(t1, process.hrtime())
        if res.statusCode == 200
          # TODO clean up on deletes
          Spaces.logger.debug("[%s][%s] SUCCESS: DELETE %s", site.site_id, userId, sPath)
          ondestroy()
          onsuccess(msecs)
        else
          Spaces.logger.error("[%s][%s] FAIL: DELETE %s (%d - %s)", site.site_id, userId, sPath, res.statusCode, res.status)
          onfail(msecs)
      ))
    ))
    req.on('error', ((e) ->
      Spaces.logger.error("[%s][%s] FAIL: DELETE %s (%s - %s)\n%s", site.site_id, userId, sPath, req.statusCode, e.message, e.stack)
      onfail()
    ))
    req.end()

  @editResource = (site, userId, sessionId, sPath, dataJson, onsuccess, onfail) ->
    Spaces = require('./spaces-client')

    data = $.param dataJson

    host = site.full_url.match(/https:\/\/(.*)$/)[1]
    opts = {
      hostname: host,
      path: "/" + sPath,
      method: 'PUT',
      headers: {
        "Content-Type": "application/x-www-form-urlencoded"
        "Accept": 'application/vnd.moxiesoft.spaces-v1+json'
        "Cookie": ["_social_navigator_session=" + sessionId, "path=/"]
      }
    }

    nock(site.full_url).put(opts.path).reply(200, { }) if mockSpacesRequests && host.match(/moxiedev/)

    req = require('https').request(opts, ((res) ->
      t1 = process.hrtime()
      res.setEncoding('utf8')
      res.on('end', (() ->
        msecs = Util.hrdiff(t1, process.hrtime())
        if res.statusCode == 200
          Spaces.logger.debug("[%s][%s] SUCCESS: PUT %s", site.site_id, userId, sPath)
          onsuccess(msecs)
        else
          Spaces.logger.error("[%s][%s] FAIL: PUT %s (%d - %s)", site.site_id, userId, sPath, res.statusCode, res.status)
          onfail(msecs)
      ))
    ))
    req.on('error', ((e) ->
      Spaces.logger.error("[%s][%s] FAIL: PUT %s (%s - %s)\n%s", site.site_id, userId, sPath, req.statusCode, e.message, e.stack)
      onfail()
    ))
    req.write(data)
    req.end()

module.exports = exports = Resource
