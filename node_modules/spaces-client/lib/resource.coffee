class Resource
  $ = require('jquery')

  @getResource = (host, userId, sessionId, sPath, addlHeaders, onsuccess, onfail) ->
    Spaces = require('./spaces-client')

    try site_id = host.match(/(.*)\..*$/)[1]
    catch e then site_id = "unknown"

    headers = {
      "Accept": "application/vnd.moxiesoft.spaces-v1+json"
    }
    if addlHeaders
      headers = $.extend({}, headers, addlHeaders)

    opts = {
      headers: headers,
      hostname: host,
      path: sPath
    }

    Spaces.logger.debug JSON.stringify(opts)
    req = require('https').request(opts, ((res) ->
      res.setEncoding('utf8')
      resp = ""
      res.on('data', ((chunk) ->
#        process.stdout.write(chunk)
#        resp += chunk.toString("utf-8")
        resp += chunk
      ))
      res.on('end', (() ->
        if res.statusCode == 200
          onsuccess(resp)
        else
          Spaces.logger.debug("[%s][%s] FAIL: GET %s (%d - %s)", site_id, userId, sPath, res.statusCode, res.status)
          onfail()
      ))
    ))
    req.on('error', ((e) ->
      Spaces.logger.error("[%s][%s] FAIL: GET %s (%s - %s)\n%s", site_id, userId, sPath, req.statusCode, e.message, e.stack)
      onfail()
    ))
    req.end()

  @createResource = (site, userId, sessionId, sPath, dataJson, onsuccess, onfail, oncreate) ->
    Spaces = require('./spaces-client')


    unless sessionId
      Spaces.logger.error("[%s][%s] NO SESSION ID", site.site_id, userId)
      return false

    data = $.param dataJson

    opts = {
      hostname: site.full_url.match(/https:\/\/(.*)$/)[1],
      path: "/" + sPath,
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "Accept": "application/vnd.moxiesoft.spaces-v1+json",
        "Cookie": ["_social_navigator_session=" + sessionId, "path=/"]
      }
    }

    resp = ""
    req = require('https').request(opts, ((res) ->
      res.setEncoding('utf8')
      res.on('data', ((chunk) ->
        resp += chunk
      ))
      res.on('end', (() ->
        if res.statusCode == 200 || res.statusCode == 201
          id = resp.match(/"id":"(.*?)"/)[1]
          Spaces.logger.debug("[%s][%s] SUCCESS: POST %s", site.site_id, userId, sPath)
          oncreate(id)
          onsuccess()
        else
          Spaces.logger.debug("[%s][%s] FAIL: POST %s (%d - %s)", site.site_id, userId, sPath, res.statusCode, res.status)
          onfail()
      ))
    ))
    req.on('error', ((e) ->
      Spaces.logger.error("[%s][%s] FAIL: POST %s (%s - %s)\n%s", site.site_id, userId, sPath, req.statusCode, e.message, e.stack)
      onfail()
    ))
    req.write(data)
    req.end()

  @deleteResource = (site, userId, sessionId, sPath, onsuccess, onfail, ondestroy) ->
    Spaces = require('./spaces-client')

    opts = {
      hostname: site.full_url.match(/https:\/\/(.*)$/)[1],
      path: "/" + sPath,
      method: 'DELETE',
      headers: {
        "Accept": 'application/vnd.moxiesoft.spaces-v1+json'
        "Cookie": ["_social_navigator_session=" + sessionId, "path=/"]
      }
    }
    req = require('https').request(opts, ((res) ->
      res.setEncoding('utf8')
      res.on('end', (() ->
        if res.statusCode == 200
          # TODO clean up on deletes
          Spaces.logger.debug("[%s][%s] SUCCESS: DELETE %s", site.site_id, userId, sPath)
          ondestroy()
          onsuccess()
        else
          Spaces.logger.debug("[%s][%s] FAIL: DELETE %s (%d - %s)", site.site_id, userId, sPath, res.statusCode, res.status)
          onfail()
      ))
    ))
    req.on('error', ((e) ->
      Spaces.logger.error("[%s][%s] FAIL: DELETE %s (%s - %s)\n%s", site.site_id, userId, sPath, req.statusCode, e.message, e.stack)
      onfail()
    ))
    req.end()

  @editResource = (site, userId, sessionId, sPath, dataJson, onsuccess, onfail) ->
    Spaces = require('./spaces-client')

    data = $.param dataJson

    opts = {
      hostname: site.full_url.match(/https:\/\/(.*)$/)[1],
      path: "/" + sPath,
      method: 'PUT',
      headers: {
        "Content-Type": "application/x-www-form-urlencoded"
        "Accept": 'application/vnd.moxiesoft.spaces-v1+json'
        "Cookie": ["_social_navigator_session=" + sessionId, "path=/"]
      }
    }

    req = require('https').request(opts, ((res) ->
      res.setEncoding('utf8')
      res.on('end', (() ->
        if res.statusCode == 200
          Spaces.logger.debug("[%s][%s] SUCCESS: PUT %s", site.site_id, userId, sPath)
          onsuccess()
        else
          Spaces.logger.debug("[%s][%s] FAIL: PUT %s (%d - %s)", site.site_id, userId, sPath, res.statusCode, res.status)
          onfail()
      ))
    ))
    req.on('error', ((e) ->
      Spaces.logger.error("[%s][%s] FAIL: PUT %s (%s - %s)\n%s", site.site_id, userId, sPath, req.statusCode, e.message, e.stack)
      onfail()
    ))
    req.write(data)
    req.end()

module.exports = exports = Resource
