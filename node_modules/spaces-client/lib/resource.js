// Generated by CoffeeScript 1.6.3
(function() {
  var Resource, exports;

  Resource = (function() {
    var $;

    function Resource() {}

    $ = require('jquery');

    Resource.getResource = function(host, userId, sessionId, resourceId, resourceName, sPath, addlHeaders, onsuccess, onfail) {
      var Spaces, e, headers, opts, req, site_id;
      Spaces = require('./spaces-client');
      try {
        site_id = host.match(/(.*)\..*$/)[1];
      } catch (_error) {
        e = _error;
        site_id = "unknown";
      }
      headers = {
        "Accept": "application/vnd.moxiesoft.spaces-v1+json"
      };
      if (addlHeaders) {
        headers = $.extend({}, headers, addlHeaders);
      }
      opts = {
        headers: headers,
        hostname: host,
        path: sPath || ('/' + this.pluralize(resourceName) + '/' + resourceId)
      };
      req = require('https').request(opts, (function(res) {
        res.setEncoding('utf8');
        return res.on('end', (function() {
          if (res.statusCode === 200) {
            if (id) {
              Spaces.logger.debug("[%s][%s] Got %s [%s]", site_id, userId, resourceName, resourceId);
            } else {
              Spaces.logger.debug("[%s][%s] Got %s", site_id, userId, resourceName);
            }
            return onsuccess();
          } else {
            Spaces.logger.error("[%s][%s] %s#get/%s failed: %d - %s", site_id, userId, resourceName, res.statusCode, res.status);
            return onfail();
          }
        }));
      }));
      req.on('error', (function(e) {
        Spaces.logger.error("[%s][%s] %s#get/%s failed: [%s] %s\n%s", site_id, userId, resourceName, req.statusCode, e.message, e.stack);
        return onfail();
      }));
      return req.end();
    };

    Resource.createResource = function(site, userId, sessionId, resourceName, dataJson, onsuccess, onfail, oncreate) {
      var Spaces, data, opts, req, resp;
      Spaces = require('./spaces-client');
      if (!sessionId) {
        Spaces.logger.error("[%s][%s] NO SESSION ID", site.site_id, userId);
      }
      data = $.param(dataJson);
      opts = {
        hostname: site.full_url.match(/https:\/\/(.*)$/)[1],
        path: "/" + this.pluralize(resourceName),
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "Accept": "application/vnd.moxiesoft.spaces-v1+json",
          "Cookie": ["_social_navigator_session=" + sessionId, "path=/"]
        }
      };
      resp = "";
      req = require('https').request(opts, (function(res) {
        res.setEncoding('utf8');
        res.on('data', (function(chunk) {
          return resp += chunk;
        }));
        return res.on('end', (function() {
          var id;
          if (res.statusCode === 200 || res.statusCode === 201) {
            id = resp.match(/"id":"(.*?)"/)[1];
            Spaces.logger.info("[%s][%s] Created %s [id: %s]", site.site_id, userId, resourceName, id);
            if (oncreate) {
              oncreate(resourceName, id);
            }
            return onsuccess();
          } else {
            Spaces.logger.error("[%s][%s] %s#create/%s failed: %d - %s", site.site_id, userId, resourceName, res.statusCode, res.status);
            return onfail();
          }
        }));
      }));
      req.on('error', (function(e) {
        Spaces.logger.error("[%s][%s] %s#delete/%s failed: [%s] %s\n%s", site.site_id, userId, resourceName, req.statusCode, e.message, e.stack);
        return onfail();
      }));
      req.write(data);
      return req.end();
    };

    Resource.deleteResource = function(site, userId, sessionId, resourceId, resourceName, onsuccess, onfail, ondestroy) {
      var Spaces, opts, req;
      Spaces = require('./spaces-client');
      opts = {
        hostname: site.full_url.match(/https:\/\/(.*)$/)[1],
        path: "/" + resourceName + "s/" + resourceId,
        method: 'DELETE',
        headers: {
          "Accept": 'application/vnd.moxiesoft.spaces-v1+json',
          "Cookie": ["_social_navigator_session=" + sessionId, "path=/"]
        }
      };
      req = require('https').request(opts, (function(res) {
        res.setEncoding('utf8');
        return res.on('end', (function() {
          if (res.statusCode === 200) {
            Spaces.logger.debug("[%s][%s] Deleted %s [%s]", site.site_id, userId, resourceName, resourceId);
            if (ondestroy) {
              ondestroy(resourceId);
            }
            return onsuccess();
          } else {
            Spaces.logger.debug("[%s][%s] %s#delete/%s failed: %d - %s", site.site_id, userId, resourceName, resourceId, res.statusCode, res.status);
            return onfail();
          }
        }));
      }));
      req.on('error', (function(e) {
        Spaces.logger.error("[%s][%s] %s#delete/%s failed: %s - %s\n%s", site.site_id, userId, resourceName, resourceId, req.statusCode, e.message, e.stack);
        return onfail();
      }));
      return req.end();
    };

    Resource.editResource = function(site, userId, sessionId, resourceName, resourceId, dataJson, onsuccess, onfail) {
      var Spaces, data, opts, req;
      Spaces = require('./spaces-client');
      data = $.param(dataJson);
      opts = {
        hostname: site.full_url.match(/https:\/\/(.*)$/)[1],
        path: "/" + resourceName + "s/" + resourceId,
        method: 'PUT',
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "Accept": 'application/vnd.moxiesoft.spaces-v1+json',
          "Cookie": ["_social_navigator_session=" + sessionId, "path=/"]
        }
      };
      req = require('https').request(opts, (function(res) {
        res.setEncoding('utf8');
        return res.on('end', (function() {
          if (res.statusCode === 200) {
            Spaces.logger.debug("[%s][%s] Updated %s [%s]", site.site_id, userId, resourceName, resourceId);
            return onsuccess();
          } else {
            Spaces.logger.error("[%s][%s] %s#update/%s failed: %d - %s", site.site_id, userId, resourceName, resourceId, res.statusCode, res.status);
            return onfail();
          }
        }));
      }));
      req.on('error', (function(e) {
        Spaces.logger.error("[%s][%s] %s#update/%s failed: %s - %s\n%s", site.site_id, userId, resourceName, resourceId, req.statusCode, e.message, e.stack);
        return onfail();
      }));
      req.write(data);
      return req.end();
    };

    Resource.pluralize = function(resourceName) {
      var plural;
      if (resourceName === "activity") {
        plural = "activities";
      } else if (resourceName === "category") {
        plural = "categories";
      } else if (resourceName === "document_library") {
        plural = "document_libraries";
      } else {
        plural = resourceName + 's';
      }
      return plural;
    };

    return Resource;

  })();

  module.exports = exports = Resource;

}).call(this);
