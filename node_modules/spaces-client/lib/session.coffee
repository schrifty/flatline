logger = require('./logger.js')

class Session
  @sessions = {}
  @adminId = ""

  @setAdminId = (userId) ->
    @adminId = userId

  @setSessionId = (userId, id) ->
    @sessions[userId] = {} unless @sessions[userId]
    @sessions[userId]["id"] = id

  @getSessionId = (site, userId) ->
    if session = @sessions[userId]
      if sessionId = session["id"]
        return sessionId
      else
        logger.error("[%s][%s] Couldn't find session ID", site.site_id, userId)
    else
      logger.error("[%s][%s] Couldn't find user session", site.site_id, userId)

  @getRandomUserItemIdOfType = (site, userId, type) ->
    if @sessions[userId]
      if list = @sessions[userId][type]
        return list[Math.floor(Math.random() * list.length)]
      else
        logger.warn("[%s][%s] user doesn't have a valid %s", site.site_id, userId, type)
    else
      logger.error("[%s][%s] Couldn't find user session", site.site_id, userId)

  @getRandomSiteItemIdOfType = (site, type) ->
    if @sessions[site.site_id]
      if list = @sessions[site.site_id][type]
        return list[Math.floor(Math.random() * list.length)]
      else
        logger.warn("[%s][Unknown User] site doesn't have a valid %s", site.site_id, type)

  @addItem = (site, userId, type, item) ->
    logger.debug("[%s][%s]: Added %s [%s]", site.site_id, userId, type, item)
    if @sessions[userId]
      @sessions[userId][type] = [] unless @sessions[userId][type]
      @sessions[userId][type].push item
    else
      logger.error("[%s][%s] user session not found", site.site_id, userId)

    # store the item for the site as well
    @sessions[site.site_id] = {} unless @sessions[site.site_id]
    @sessions[site.site_id][type] = [] unless @sessions[site.site_id][type]
    @sessions[site.site_id][type].push item

module.exports = exports = Session