// Generated by CoffeeScript 1.6.3
(function() {
  var Runner, SITE_CREATE_FREQUENCY_MS;

  SITE_CREATE_FREQUENCY_MS = 5000;

  Runner = (function() {
    var Faker, Spaces, maxServers, maxSites;

    function Runner() {}

    maxSites = 1;

    maxServers = 5;

    Runner.sites = [];

    Spaces = new require('spaces-client');

    Faker = require('Faker');

    Runner.createSite = function() {
      var data, site_name;
      site_name = "xx" + Faker.Internet.domainWord();
      data = {
        site: {
          site_id: site_name,
          customer_name: "Acme",
          site_type_name: "Freemium",
          settings: {
            skip_signup_activation: true
          }
        }
      };
      return Spaces.Site.createSite(data, (function(site, cookie) {
        var callback;
        Runner.sites.push(site);
        Runner.createUser(site);
        if (Runner.sites.length < maxSites) {
          callback = function() {
            return Runner.createSite();
          };
          return setTimeout(callback, (SITE_CREATE_FREQUENCY_MS / 2) + Math.random(SITE_CREATE_FREQUENCY_MS));
        }
      }), (function(message) {
        return console.log(message);
      }));
    };

    Runner.createUser = function(site) {
      var data, email, password;
      if (!(Runner.sites.length > 0)) {
        Runner.sites.push(site);
      }
      password = "L1berty*";
      email = Faker.Internet.email();
      data = {
        user: {
          email: email,
          display_name: Faker.Name.findName(),
          password: password,
          password_confirmation: password
        }
      };
      return Spaces.User.create(data, site.full_url, (function(user) {
        var callback, userId;
        userId = JSON.stringify(user).match(/^.*"id":"(.*?)".*/)[1];
        Runner.login(site, email, password, (function(chunk, cookies) {
          Spaces.Session.setSessionId(userId, cookies['_social_navigator_session']);
          if (!site.users) {
            site.users = [];
          }
          site.users.push(userId);
          return Runner.startActivity(site, userId);
        }), (function() {
          return console.log("User failed to log in [" + email + ":" + password + "]");
        }));
        callback = function() {
          return Runner.createUser(site);
        };
        return setTimeout(callback, 1000);
      }), (function(message) {
        return console.log(message);
      }));
    };

    Runner.login = function(site, email, password, onsuccess, onfail) {
      var data;
      if (!(Runner.sites.length > 0)) {
        Runner.sites.push(site);
      }
      data = {
        user: {
          email: email,
          password: password
        }
      };
      return Spaces.Site.login(data, site, (function(chunk, cookies) {
        return onsuccess(chunk, cookies);
      }), (function(msg) {
        return onfail(msg);
      }));
    };

    Runner.startActivity = function(site, userId) {
      var Action, callback;
      Action = require("./action.js");
      Action.doSomething(Runner.sites, site.full_url, userId);
      callback = function() {
        return Runner.startActivity(site, userId);
      };
      return setTimeout(callback, 10000);
    };

    return Runner;

  })();

  module.exports = Runner;

}).call(this);
